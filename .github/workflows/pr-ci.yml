name: PR CI

on:
  pull_request:
    # Trigger when a pull request (MR) is opened, updated, or reopened
    types: [opened, synchronize, reopened, ready_for_review]

env:
  DOTNET_VERSION: "10.0.x"           # Keep in sync with your SDK / TargetFramework
  SOLUTION_FILE: "clean-architecture.slnx"
  BUILD_CONFIGURATION: "Release"
  TEST_RESULTS_DIR: "TestResults"
  SBOM_OUTPUT_FILE: "dependency-sbom.spdx.json"
  SBOM_FORMAT: "spdx-json"

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          cache: true
          cache-dependency-path: '**/*.csproj'

      - name: Restore dependencies
        run: dotnet restore $SOLUTION_FILE

      - name: Build solution
        run: dotnet build $SOLUTION_FILE --configuration $BUILD_CONFIGURATION --no-restore

      - name: Run tests
        run: dotnet test $SOLUTION_FILE --configuration $BUILD_CONFIGURATION --no-build --logger trx --results-directory $TEST_RESULTS_DIR

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: dotnet-test-results
          path: ${{ env.TEST_RESULTS_DIR }}

  lint-and-format:
     name: Lint and Formatting Check
     runs-on: ubuntu-latest
     steps:
       - name: Checkout repository
         uses: actions/checkout@v6

       - name: Setup .NET SDK
         uses: actions/setup-dotnet@v5
         with:
           dotnet-version: ${{ env.DOTNET_VERSION }}

       - name: Restore dependencies
         run: dotnet restore $SOLUTION_FILE

       - name: Enforce dotnet format (style & analyzers)
         run: |
           dotnet format --verify-no-changes

       - name: Verify CI security configuration
         run: |
           bash scripts/verify-ci-security.sh

  security-and-deps:
    name: Dependency and Security Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          cache: true
          cache-dependency-path: '**/*.csproj'

      - name: Restore dependencies
        run: dotnet restore $SOLUTION_FILE

      - name: Check for vulnerable packages
        run: dotnet list package --vulnerable --include-transitive

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          path: .
          format: ${{ env.SBOM_FORMAT }}
          output-file: ${{ env.SBOM_OUTPUT_FILE }}
          upload-artifact: false

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v6
        with:
          name: dependency-sbom
          path: ${{ env.SBOM_OUTPUT_FILE }}
  #
  # coverage-report:
  #   name: Test Coverage (example)
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v6
  #
  #     - name: Setup .NET SDK
  #       uses: actions/setup-dotnet@v5
  #       with:
  #         dotnet-version: ${{ env.DOTNET_VERSION }}
  #
  #     - name: Run tests with coverage
  #       run: |
  #         dotnet test $SOLUTION_FILE --configuration $BUILD_CONFIGURATION --collect "Code Coverage" --results-directory $TEST_RESULTS_DIR
  #
  #     - name: Upload coverage
  #       uses: actions/upload-artifact@v6
  #       with:
  #         name: coverage-results
  #         path: ${{ env.TEST_RESULTS_DIR }}
